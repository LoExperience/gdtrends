<html>
   <head> 
      <title>GDtrends!</title> 
      <meta>
      <style> 
            canvas {
                background-color: rgba(62, 142, 204, 11);
            }
       </style>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <h1>GDtrends!</h1>
        <canvas id="chart" width="1000px" height="400px"></canvas>
            <script>

            chartIt(); //calls function to create chart
            
            // function to create chart using chart.js
            async function chartIt(){
                let dataAnimXs = [];
                let dataAnimYmonth = []
                let dataAnimYcum = []
                const data = await getData();
                let xMax = Math.max(...data.yMonth) + 100 - (Math.max(...data.yMonth) % 100)
                let chartOptions = {
                    animations: {
                        radius: {
                            duration: 1000,
                            easing: 'easeInQuad',
                            from: 1,
                            to: 0,
                            loop: true
                        }
                    },
                        layout: {
                            padding: 50
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false,
                                    fontColor: 'rgba(255, 255, 255, 1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 1)'
                                }
                            },
                            y: {
                                min: 0,
                                max: xMax, //seperator operator for Math.max to work on array
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 1)'
                                }
                            }
                        }
                }
                let chartData = {
                    labels: data.xs,
                    datasets: [{
                            type: 'bar',
                            label: 'New Repos',
                            data: dataAnimYmonth,
                            borderWidth: 1,
                            backgroundColor:'rgb(212,237,255)'
                                },{
                            type: 'line',
                            label: "Running Total",
                            data: dataAnimYcum,
                            fill: true,
                            backgroundColor: 'rgba(255, 255, 255, 1)'
                        }]
                }
                const ctx = document.getElementById('chart');
                const myChart = new Chart(ctx, {
                    data: chartData,
                    options: chartOptions
                    });
                
                //update chart on start up
                let updateChart = setInterval(
                    function(){
                        if (dataAnimYmonth.length != data.yMonth.length){
                            dataAnimYmonth.push(data.yMonth[dataAnimYmonth.length])
                        } else{
                            // dataAnimYcum = data.yCum.slice()
                            var delayUpdate = setTimeout(
                                    function(){
                                        let updateCum = setInterval(
                                            function(){
                                                dataAnimYcum.push(data.yCum[dataAnimYcum.length])
                                                if (Math.max(...dataAnimYcum) >  xMax){
                                                    myChart.options.scales.y.max = Math.max(...dataAnimYcum)
                                                }
                                                if (dataAnimYcum.length == data.yCum.length){
                                                    clearInterval(updateCum)
                                                }
                                                myChart.update();
                                            }, 50
                                        )


                                        // for(let i = 0; i < data.yCum.length; i++){
                                        //     dataAnimYcum.push(data.yCum[dataAnimYcum.length])
                                        //     myChart.options.scales.y.max = Math.max(...dataAnimYcum)
                                        //     myChart.update();
                                        // }
                                    }, 500
                                )
                            clearInterval(updateChart)
                    }
                    myChart.update();
                    }, 50);
                }

                function sleep(cht, data) {
                    setTimeout(function(){ 
                        console.log(cht)
                        console.log(data)
                        cht.update(); 
                    }, 3000);
                }    

            async function getData(){
                let yMonth = [];
                let yCum = [];
                let xs = [];
                const response = await fetch('sample.json');
                const data = await response.json();
                const yearKeys = Object.keys(data);
                const yearLen = yearKeys.length;
                for (let i = 0; i < yearLen; i++){
                    const year = yearKeys[i];
                    const monthKey = Object.keys(data[year]);
                    const monthLen = monthKey.length;
                    for(let j = 0; j < monthLen; j++){
                        const row = monthKey[j] + " " + year;
                        xs.push(row);
                        const col = data[year][monthKey[j]];
                        yMonth.push(col);
                        if (yMonth.length == 1){
                            yCum.push(parseFloat(col))
                        }else{
                            yCum.push(parseFloat(col) + parseFloat(yCum[yCum.length-1]))
                        }
                        }
                    }
                    return {xs, yMonth, yCum}
            }
            </script>
    </body>
</html>